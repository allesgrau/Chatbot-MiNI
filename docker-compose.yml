version: "3.9"

volumes:
  final_storage:
  chroma_db:
  hf_cache:
  data_storage:

x-env: &env
  PYTHONUNBUFFERED: "1"
  HF_HOME: /root/.cache/huggingface
  PYTHONPATH: /app/src
  OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
  FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY}
  PIPELINE_VERSION: ${PIPELINE_VERSION:-1}
  CHROMA_DIR: /app/src/data/chroma_db

services:

  scraper:
    user: root
    build: .
    command: [
      "micromamba",
      "run",
      "-n",
      "app",
      "python",
      "-m",
      "pipeline.scraper"
    ]
    environment: *env
    volumes:
      - data_storage:/app/src/data
      - final_storage:/app/src/data/final_storage
      - hf_cache:/root/.cache/huggingface

  ingest:
    user: root
    build: .
    command: >
      micromamba run -n app /bin/bash -c "
      python -m pipeline.describe_files &&
      python -m pipeline.extract_facts &&
      python -m pipeline.ingest_facts"
    environment: *env
    volumes:
      - data_storage:/app/src/data
      - chroma_db:/app/src/data/chroma_db
      - hf_cache:/root/.cache/huggingface
    depends_on:
      scraper:
        condition: service_completed_successfully

  api:
    user: root
    build: .
    command: [
      "micromamba",
      "run",
      "-n",
      "app",
      "uvicorn",
      "rag_api.api:app",
      "--host",
      "0.0.0.0",
      "--port",
      "8000"
    ]
    environment: *env
    volumes:
      - chroma_db:/app/src/data/chroma_db
    expose:
      - "8000"
    restart: always

  frontend:
    user: root
    build: .
    command: [
      "micromamba",
      "run",
      "-n",
      "app",
      "streamlit",
      "run",
      "src/frontend/app.py",
      "--server.port",
      "8501",
      "--server.address",
      "0.0.0.0"
    ]
    environment:
      <<: *env
      STREAMLIT_SERVER_ADDRESS: 0.0.0.0
      STREAMLIT_SERVER_HEADLESS: "true"
      STREAMLIT_BROWSER_GATHER_USAGE_STATS: "false"
    ports:
      - "80:8501"
    depends_on:
      - api
    restart: always
